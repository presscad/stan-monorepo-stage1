##
# LIBGTEST is the google test library
# GTEST_MAIN is the file that contains the google test
##
LIBGTEST := test/libgtest.a
GTEST_MAIN := lib/gtest/src/gtest_main.cc

MODEL_TESTS := $(shell find src/test/models -type f -name '*_test.cpp')
MODEL_TESTS := $(MODEL_TESTS:src/test/%_test.cpp=test/%)
.PHONY: test-models
test-models: $(addsuffix $(EXE),$(MODEL_TESTS))
	@echo '------------------------------------------------------------'
	set -e;\
	$(foreach test,$(MODEL_TESTS), \
	  echo '------------------------------------------------------------';\
	  $(addsuffix $(EXE),$(test)) --gtest_output="xml:$(test).xml";)

##
# Target to build unit tests. All unit tests are in src/test 
# and are named *_test.cpp
##
UNIT_TESTS := $(shell find src/test -type f -name '*_test.cpp')
UNIT_TESTS := $(UNIT_TESTS:src/test/%_test.cpp=test/%)
UNIT_TESTS := $(filter-out $(MODEL_TESTS),$(UNIT_TESTS))
UNIT_TESTS := $(filter-out $(UNIT_TESTS_TO_EXCLUDE),$(UNIT_TESTS))
.PHONY: test-unit
test-unit: $(addsuffix $(EXE),$(UNIT_TESTS))
	@echo '------------------------------------------------------------'
	set -e;\
	$(foreach test,$(UNIT_TESTS), \
	  echo '------------------------------------------------------------';\
	  $(addsuffix $(EXE),$(test)) --gtest_output="xml:$(test).xml";)

##
# Target to build bugs models
##
BUGS_EXAMPLES := $(shell cd src; find models/bugs_examples -type f -name '*.stan')
BUGS_EXAMPLES := $(BUGS_EXAMPLES:%.stan=%)
BUGS_EXAMPLES := $(filter-out $(BUGS_EXAMPLES_TO_EXCLUDE),$(BUGS_EXAMPLES))
.PHONY: test-bugs
test-bugs: $(addsuffix $(EXE),$(BUGS_EXAMPLES))
	@echo '------------------- Running bugs models --------------------'
	set -e;\
	$(foreach test,$(BUGS_EXAMPLES), \
		echo '--- $(test) ---';\
		$(addsuffix $(EXE),$(test)) --data=$(test).Rdata --samples=$(test).csv;)

##
# Target to build all tests
##
.PHONY: test-all
test-all: test-unit test-models test-bugs

##
# Build the google test library.
## 
$(LIBGTEST): $(LIBGTEST)(test/gtest.o)

test/gtest.o: lib/gtest/src/gtest-all.cc
	@mkdir -p test
	$(COMPILE.c) $< $(CFLAGS_GTEST) $(OUTPUT_OPTION)

##
# Generate autodependencies for test files.
# Adapted from the gnu make manual.
# http://www.gnu.org/software/make/manual/html_node/Automatic-Prerequisites.html#Automatic-Prerequisites
##

##
# Builds a single test with a stan model dependency
#
# Using a static pattern rule to make these tests depend on
# missing models.
##
$(addsuffix $(EXE),$(MODEL_TESTS)): test/models/%$(EXE): test/models/%.o bin/libstan.a models/%$(EXE)
	@mkdir -p $(dir $@)
	@echo '------------------------------------------------------------'
	$(CC) $(GTEST_MAIN) $< $(CFLAGS_GTEST) $(OUTPUT_OPTION) $(LDFLAGS) $(LIBGTEST) $(LDLIBS)
ifeq ($(findstring test-,$(MAKECMDGOALS)),)
	$@ --gtest_output="xml:$(basename $@).xml"
endif

##
# Builds a single test
##
test/%$(EXE) : test/%.o bin/libstan.a
	@mkdir -p $(dir $@)
	@echo '------------------------------------------------------------'
	$(CC) $(GTEST_MAIN) $< $(CFLAGS_GTEST) $(OUTPUT_OPTION) $(LDFLAGS) $(LIBGTEST) $(LDLIBS)
ifeq ($(findstring test-,$(MAKECMDGOALS)),)
	$@ --gtest_output="xml:$(basename $@).xml"
endif

.PRECIOUS: test/%.o
test/%.o : src/test/%_test.cpp $(LIBGTEST)
	@mkdir -p $(dir $@)
	$(COMPILE.c) $< $(CFLAGS_GTEST) $(OUTPUT_OPTION)

##
# Rule for generating dependencies.
##
test/%.d : src/test/%_test.cpp
	@if test -d $(dir $@); \
	then \
	(set -e; \
	rm -f $@; \
	$(CC) $(CFLAGS) $(CFLAGS_GTEST) $(TARGET_ARCH) -MM $< > $@.$$$$; \
	sed -e 's,\($(notdir $*)\)\(_test\)\.o[ :]*,$(dir $@)\1.o $@ : ,g' < $@.$$$$ > $@; \
	rm -f $@.$$$$ ); \
	fi

##
# If the target is a unit test, include .d. 
# Will generate dependencies.
##
ifeq (test-unit,$(MAKECMDGOALS))
  -include $(addsuffix .d,$(UNIT_TESTS))
endif
#ifeq (test-bugs,$(MAKECMDGOALS))
#  -include $(addsuffix .d,$(UNIT_TESTS))
#  -include demo/gm.d
#endif
ifeq (test-all,$(MAKECMDGOALS))
  -include $(addsuffix .d,$(UNIT_TESTS))
endif
ifneq (,$(filter test/%,$(MAKECMDGOALS)))
  -include $(addsuffix .d,$(subst $(EXE),,$(filter test/%,$(MAKECMDGOALS))))
endif


##
# target path_separator for use in some tests that need to 
# call executables.
##
PATH_SEPARATOR = /
ifeq ($(OS),win)
	PATH_SEPARATOR = \\
endif
.PHONY: path_separator
path_separator :
	@echo $(PATH_SEPARATOR)
